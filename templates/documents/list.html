{% extends "base.html" %}

{% block title %}Documentos{% endblock %}

{% block content %}
  <div class="card">
    <div class="page-header">
      <h1>Documentos</h1>
    </div>

    <form class="filters-bar" method="get">
      <div class="filters-row">
        <label class="filter-field">
          <span>Filtro</span>
          <select class="input-select" name="preset">
            <option value="">Todos</option>
            {% for preset in presets %}
              <option
                value="{{ preset.id }}"
                data-keywords="{{ preset.keywords|join:'; ' }}"
                data-exp-min="{{ preset.experience_min_years|default_if_none:'' }}"
                data-age-min="{{ preset.age_min_years|default_if_none:'' }}"
                data-age-max="{{ preset.age_max_years|default_if_none:'' }}"
                {% if preset.id|stringformat:"s" == preset_id %}selected{% endif %}
              >
                {{ preset.name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label class="filter-field">
          <span>Buscar termos</span>
          <input
            class="input-text"
            type="text"
            name="q"
            value="{{ display_search_query|default:search_query }}"
            placeholder="python, django, fastapi"
          />
        </label>
        <label class="filter-field">
          <span>Excluir termos</span>
          <input
            class="input-text"
            type="text"
            name="exclude"
            value="{{ exclude_query }}"
            placeholder="estagio, junior"
          />
        </label>
        <div class="filter-toggle">
          <span>Modo</span>
          <div class="toggle-options">
            <label class="toggle-option">
              <input type="radio" name="mode" value="all" {% if mode != "any" %}checked{% endif %} />
              <span>TODOS</span>
            </label>
            <label class="toggle-option">
              <input type="radio" name="mode" value="any" {% if mode == "any" %}checked{% endif %} />
              <span>QUALQUER</span>
            </label>
          </div>
        </div>
      </div>
      <div class="filters-row filters-row--extra" {% if not active_preset %}style="display:none;"{% endif %}>
        <label class="filter-field">
          <span>Experiencia minima (anos)</span>
          <input
            class="input-text"
            type="number"
            min="0"
            name="experience_min_years"
            value="{{ experience_min_value }}"
          />
        </label>
        <label class="filter-field">
          <span>Idade minima (anos)</span>
          <input
            class="input-text"
            type="number"
            min="0"
            name="age_min_years"
            value="{{ age_min_value }}"
          />
        </label>
        <label class="filter-field">
          <span>Idade maxima (anos)</span>
          <input
            class="input-text"
            type="number"
            min="0"
            name="age_max_years"
            value="{{ age_max_value }}"
          />
        </label>
      </div>
      <div class="filters-actions">
        <button class="btn btn-primary btn-sm" type="submit">Aplicar</button>
        <a class="btn btn-ghost btn-sm" href="{% url 'documents_list' %}">Limpar filtros</a>
        <span class="results-meta">{{ result_count }} documento{{ result_count|pluralize:"s" }}</span>
        {% if active_preset %}
          <span class="results-meta">Filtro: {{ active_preset.name }}</span>
        {% endif %}
        {% if filters_active and processing_count %}
          <span class="results-meta">Documentos em processamento nao entram nos filtros.</span>
        {% endif %}
      </div>
    </form>

    <div class="bulk-actions">
      <form id="bulk-form" method="post" action="{% url 'process_documents_bulk' %}" class="bulk-form">
        {% csrf_token %}
        <button class="btn btn-secondary btn-sm" name="action" value="reprocess" type="submit">Reprocessar selecionados</button>
        <button class="btn btn-ghost btn-sm" type="submit" formaction="{% url 'download_documents_json_bulk' %}">Download JSON selecionados</button>
        <button class="btn btn-ghost btn-sm" type="submit" formaction="{% url 'download_documents_files_bulk' %}">Download arquivos selecionados</button>
      </form>
      <button class="btn btn-ghost btn-sm" type="button" id="select-all">Selecionar todos</button>
    </div>

    <div class="table-card">
      <table class="table table-resizable">
        <colgroup>
          <col class="col-select" />
        <col class="col-name" />
        <col class="col-date" />
        <col class="col-info" />
        <col class="col-contact" />
        <col class="col-status" />
        <col class="col-actions" />
        </colgroup>
        <thead>
          <tr>
            <th class="col-select" data-min-width="40">Sel</th>
            <th data-min-width="160">Nome do documento</th>
            <th data-min-width="120">Data cadastro</th>
            <th data-min-width="220">Informações</th>
            <th data-min-width="150">Contato</th>
            <th data-min-width="110">Status</th>
            <th data-min-width="170">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for d in page_obj %}
            <tr>
              <td class="col-select">
                <input type="checkbox" name="ids" value="{{ d.id }}" form="bulk-form" aria-label="Selecionar documento {{ d.id }}" />
              </td>
              <td>
                <div class="doc-name">{% firstof d.original_filename "Arquivo" %}</div>
              </td>
              <td>
                <div class="date-stack">
                  <span>{{ d.uploaded_at|date:"d/m/Y" }}</span>
                  <span class="time">{{ d.uploaded_at|date:"H:i" }}</span>
                </div>
              </td>
              <td class="doc-info">
                {% if d.search_snippet %}
                  <div class="doc-snippet">{{ d.search_snippet }}</div>
                {% else %}
                  <div class="info-empty">—</div>
                {% endif %}
              </td>
              <td>
                {% if d.contact_phone %}
                  <a href="https://web.whatsapp.com/send?phone={{ d.contact_phone }}" target="_blank" rel="noopener noreferrer">
                    {{ d.contact_phone }}
                  </a>
                {% else %}
                  <div class="info-empty">—</div>
                {% endif %}
              </td>
              <td>
                <span class="status-badge status-{{ d.status|lower }}">{{ d.get_status_display }}</span>
                {% if d.status == "FAILED" and d.error_message %}
                  <span class="error-hint" title="{{ d.error_message }}">Erro</span>
                {% endif %}
                {% if d.processed_at and d.status == "DONE" %}
                {% elif d.processed_at and d.status == "FAILED" %}
                  <div class="status-meta">Falhou: {{ d.processed_at|date:"d/m/Y H:i" }}</div>
                {% endif %}
              </td>
              <td>
                <div class="actions">
                  {% if d.status == "DONE" %}
                    <form method="post" action="{% url 'process_document' d.id %}" class="inline-form">
                      {% csrf_token %}
                      <input type="hidden" name="reprocess" value="1" />
                      <button type="submit" class="btn btn-secondary btn-sm">Reprocessar</button>
                    </form>
                  {% endif %}
                  <details class="drop">
                    <summary class="btn btn-ghost btn-sm">⋯</summary>
                    <div class="drop-menu">
                      {% if d.extracted_json %}
                        <a href="{% url 'document_json' d.id %}">Ver JSON</a>
                        <a href="{% url 'document_json_download' d.id %}">Download JSON</a>
                      {% else %}
                        <span class="drop-item is-disabled">Ver JSON</span>
                        <span class="drop-item is-disabled">Download JSON</span>
                      {% endif %}
                      <a href="{% url 'download_document' d.id %}">Download arquivo</a>
                    </div>
                  </details>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7">Nenhum documento enviado ainda.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <span>Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_previous %}
        <a class="btn btn-ghost" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Anterior</a>
      {% endif %}
      {% if page_obj.has_next %}
        <a class="btn btn-ghost" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Proxima</a>
      {% endif %}
    </div>
  </div>

  <script>
    (function () {
      const table = document.querySelector(".table-resizable");
      if (!table) {
        return;
      }

      const headerRow = table.querySelector("thead tr");
      if (!headerRow) {
        return;
      }

      const headers = Array.from(headerRow.children);
      let colgroup = table.querySelector("colgroup");
      if (!colgroup) {
        colgroup = document.createElement("colgroup");
        headers.forEach(() => colgroup.appendChild(document.createElement("col")));
        table.insertBefore(colgroup, table.querySelector("thead"));
      }

      const cols = Array.from(colgroup.children);
      if (cols.length !== headers.length) {
        colgroup.innerHTML = "";
        headers.forEach(() => colgroup.appendChild(document.createElement("col")));
      }

      const getMinWidth = (th) => {
        const raw = th.getAttribute("data-min-width");
        const parsed = parseInt(raw || "", 10);
        if (Number.isNaN(parsed)) {
          return 60;
        }
        return Math.max(parsed, 40);
      };

      headers.forEach((th, index) => {
        const col = cols[index];
        const width = Math.max(getMinWidth(th), Math.round(th.getBoundingClientRect().width));
        col.style.width = `${width}px`;

        const handle = document.createElement("span");
        handle.className = "col-resizer";
        handle.addEventListener("mousedown", (event) => {
          event.preventDefault();
          const startX = event.pageX;
          const startWidth = col.getBoundingClientRect().width;
          const minWidth = getMinWidth(th);

          const onMouseMove = (moveEvent) => {
            const delta = moveEvent.pageX - startX;
            const nextWidth = Math.max(minWidth, startWidth + delta);
            col.style.width = `${nextWidth}px`;
          };

          const onMouseUp = () => {
            document.removeEventListener("mousemove", onMouseMove);
            document.removeEventListener("mouseup", onMouseUp);
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
          };

          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
        });

        th.appendChild(handle);
      });
    })();
  </script>
  <script>
    (function () {
      const selectAllButton = document.getElementById("select-all");
      const checkboxes = Array.from(document.querySelectorAll('input[name="ids"]'));
      if (!selectAllButton || checkboxes.length === 0) {
        return;
      }

      const updateLabel = () => {
        const allChecked = checkboxes.every((checkbox) => checkbox.checked);
        selectAllButton.textContent = allChecked ? "Desmarcar todos" : "Selecionar todos";
      };

      selectAllButton.addEventListener("click", () => {
        const allChecked = checkboxes.every((checkbox) => checkbox.checked);
        checkboxes.forEach((checkbox) => {
          checkbox.checked = !allChecked;
        });
        updateLabel();
      });

      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", updateLabel);
      });

      updateLabel();
    })();
  </script>
  <script>
    (function () {
      const presetSelect = document.querySelector('select[name="preset"]');
      const searchInput = document.querySelector('input[name="q"]');
      const extraRow = document.querySelector(".filters-row--extra");
      const expInput = document.querySelector('input[name="experience_min_years"]');
      const ageMinInput = document.querySelector('input[name="age_min_years"]');
      const ageMaxInput = document.querySelector('input[name="age_max_years"]');
      if (!presetSelect || !searchInput) {
        return;
      }

      const getDataAttr = (name) => {
        const option = presetSelect.options[presetSelect.selectedIndex];
        if (!option) {
          return "";
        }
        return option.getAttribute(name) || "";
      };

      const applyKeywords = () => {
        const keywords = getDataAttr("data-keywords");
        searchInput.value = keywords;
        if (extraRow) {
          extraRow.style.display = presetSelect.value ? "" : "none";
        }
        if (expInput) {
          expInput.value = getDataAttr("data-exp-min");
        }
        if (ageMinInput) {
          ageMinInput.value = getDataAttr("data-age-min");
        }
        if (ageMaxInput) {
          ageMaxInput.value = getDataAttr("data-age-max");
        }
      };

      presetSelect.addEventListener("change", applyKeywords);

      if (!searchInput.value) {
        const keywords = getDataAttr("data-keywords");
        if (keywords) {
          searchInput.value = keywords;
        }
      }

      if (!presetSelect.value && extraRow) {
        extraRow.style.display = "none";
      }
    })();
  </script>
{% endblock %}
